<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PixelBuddy Ivy Pro Deluxe</title>
    <style>
        :root {
            --bg-color: #000000;
            --ivy-eye: #ffffff;
            --blush-pink: rgba(255, 120, 180, 0.5);
            --rain-blue: #4fc3f7;
            --sun-hot: #ff4500;
            --sun-center: #ff8c00;
        }

        * { box-sizing: border-box; }

        body {
            background-color: var(--bg-color);
            margin: 0; padding: 0;
            width: 100vw; height: 100vh;
            overflow: hidden;
            display: flex; flex-direction: column;
            justify-content: center; align-items: center;
            font-family: sans-serif;
            color: white;
            touch-action: manipulation;
        }

        /* ProtecciÃ³n AMOLED contra quemado */
        #amoled-safe-zone {
            width: 100%; height: 100%;
            display: flex; justify-content: center; align-items: center;
            animation: burnOrbit 600s linear infinite;
        }

        @keyframes burnOrbit {
            0% { transform: translate(0, 0); }
            25% { transform: translate(3px, 3px); }
            50% { transform: translate(0, 6px); }
            75% { transform: translate(-3px, 3px); }
            100% { transform: translate(0, 0); }
        }

        #ivy-container {
            position: relative;
            width: 95vw;
            max-width: 450px;
            height: 75vh;
            display: flex; justify-content: center; align-items: center;
            animation: floatBody 4s ease-in-out infinite;
        }

        @keyframes floatBody {
            0%, 100% { transform: translateY(0) scale(1); }
            50% { transform: translateY(-10px) scale(1.02); }
        }

        #overlay-canvas {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; z-index: 10;
        }

        /* PartÃ­culas y Efectos */
        .particle { position: absolute; pointer-events: none; }

        .zzz {
            font-weight: 900; font-size: 35px;
            animation: zzzFly 3s ease-out forwards;
        }
        @keyframes zzzFly {
            0% { transform: translate(0,0) scale(0.5); opacity: 0; }
            30% { opacity: 1; }
            100% { transform: translate(70px, -200px) scale(2); opacity: 0; }
        }

        .heart {
            font-size: 35px; color: #ff3366;
            animation: heartPop 2s ease-out forwards;
        }
        @keyframes heartPop {
            0% { transform: scale(0); opacity: 1; }
            100% { transform: translateY(-160px) scale(2.2) rotate(30deg); opacity: 0; }
        }

        /* Gota de sudor desde la frente */
        .sweat-drop {
            width: 12px; height: 20px;
            background: #00e5ff;
            border-radius: 0 50% 50% 50%;
            transform: rotate(45deg);
            animation: sweatDrip 2s ease-in infinite;
        }
        @keyframes sweatDrip {
            0% { transform: translateY(0) rotate(45deg); opacity: 0; }
            20% { opacity: 1; }
            100% { transform: translateY(150px) rotate(45deg); opacity: 0; }
        }

        .rain-drop {
            width: 2px; height: 15px; background: var(--rain-blue);
            animation: rainDown 0.7s linear infinite;
        }
        @keyframes rainDown { to { transform: translateY(250px); opacity: 0; } }

        /* Controles UI */
        #mode-toggle {
            position: fixed; top: 40px; right: 30px;
            width: 60px; height: 60px;
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 50%;
            display: flex; justify-content: center; align-items: center;
            cursor: pointer; z-index: 100; pointer-events: auto;
            font-size: 24px;
        }

        #status-text {
            position: fixed; bottom: 45px;
            width: 100%; text-align: center;
            font-size: 11px; letter-spacing: 5px;
            text-transform: uppercase; opacity: 0.2;
        }

        svg { width: 100%; height: 100%; overflow: visible; }
    </style>
</head>
<body onclick="handleTap()">

    <div id="mode-toggle" onclick="event.stopPropagation(); cycleMoodManual();">ðŸŽ­</div>

    <div id="amoled-safe-zone">
        <div id="ivy-container">
            <div id="overlay-canvas"></div>
            
            <svg id="ivy-svg" viewBox="0 0 200 200">
                <defs>
                    <radialGradient id="eyeGema" cx="45%" cy="40%" r="50%">
                        <stop offset="0%" stop-color="#ffffff" />
                        <stop offset="85%" stop-color="#ffffff" />
                        <stop offset="100%" stop-color="#d0d0d0" />
                    </radialGradient>
                    
                    <radialGradient id="hotSunGrad" cx="50%" cy="50%" r="50%">
                        <stop offset="0%" stop-color="#ffcc00" />
                        <stop offset="70%" stop-color="#ff4500" />
                        <stop offset="100%" stop-color="#ff0000" />
                    </radialGradient>
                </defs>

                <!-- SOL ABRASADOR (MODO HOT) -->
                <g id="weather-hot-sun" style="display: none;">
                    <circle cx="170" cy="30" r="25" fill="url(#hotSunGrad)">
                        <animate attributeName="r" values="25;28;25" dur="2s" repeatCount="indefinite" />
                    </circle>
                    <g stroke="#ff4500" stroke-width="4" stroke-linecap="round">
                        <line x1="170" y1="0" x2="170" y2="10" />
                        <line x1="170" y1="50" x2="170" y2="60" />
                        <line x1="140" y1="30" x2="150" y2="30" />
                        <line x1="190" y1="30" x2="200" y2="30" />
                    </g>
                </g>

                <!-- CLIMA: NUBE -->
                <g id="weather-cloud" style="display: none;">
                    <path d="M70,45 Q70,30 85,30 Q95,15 110,20 Q125,15 135,30 Q150,30 150,45 Z" fill="#ffffff" />
                </g>

                <!-- CLIMA: SOL NORMAL -->
                <g id="weather-sun" style="display: none;">
                    <circle cx="160" cy="35" r="18" fill="#ffd700">
                        <animateTransform attributeName="transform" type="rotate" from="0 160 35" to="360 160 35" dur="15s" repeatCount="indefinite" />
                    </circle>
                </g>

                <!-- ROSTRO -->
                <g id="main-face">
                    <circle id="blush-l" cx="42" cy="148" r="15" fill="var(--blush-pink)" opacity="0" />
                    <circle id="blush-r" cx="158" cy="148" r="15" fill="var(--blush-pink)" opacity="0" />

                    <!-- Ojos Ivy Gema -->
                    <g id="eye-l-group">
                        <ellipse id="eye-l-bg" cx="65" cy="115" rx="35" ry="35" fill="url(#eyeGema)" style="transition: all 0.3s;" />
                        <ellipse id="pupil-l" cx="65" cy="115" rx="14" ry="18" fill="#000" style="transition: all 0.3s;" />
                        <circle cx="56" cy="105" r="6" fill="#fff" opacity="0.8" />
                    </g>

                    <g id="eye-r-group">
                        <ellipse id="eye-r-bg" cx="135" cy="115" rx="35" ry="35" fill="url(#eyeGema)" style="transition: all 0.3s;" />
                        <ellipse id="pupil-r" cx="135" cy="115" rx="14" ry="18" fill="#000" style="transition: all 0.3s;" />
                        <circle cx="126" cy="105" r="6" fill="#fff" opacity="0.8" />
                    </g>

                    <!-- Cejas Hot -->
                    <path id="brow-l" d="M40,85 L75,98" stroke="white" stroke-width="7" stroke-linecap="round" opacity="0" style="transition: all 0.3s;" />
                    <path id="brow-r" d="M160,85 L125,98" stroke="white" stroke-width="7" stroke-linecap="round" opacity="0" style="transition: all 0.3s;" />

                    <path id="mouth" d="M85,165 Q100,165 115,165" fill="none" stroke="white" stroke-width="8" stroke-linecap="round" style="transition: all 0.4s;" />
                </g>
            </svg>
        </div>
    </div>

    <div id="status-text">Buscando Clima...</div>

    <script>
        const API_KEY = "9c73a28867a7fe53db5718310609a992";
        
        // Elementos DOM
        const mouth = document.getElementById('mouth');
        const eyeL = document.getElementById('eye-l-bg');
        const eyeR = document.getElementById('eye-r-bg');
        const pupilL = document.getElementById('pupil-l');
        const pupilR = document.getElementById('pupil-r');
        const browL = document.getElementById('brow-l');
        const browR = document.getElementById('brow-r');
        const blushL = document.getElementById('blush-l');
        const blushR = document.getElementById('blush-r');
        const cloud = document.getElementById('weather-cloud');
        const sunNormal = document.getElementById('weather-sun');
        const sunHot = document.getElementById('weather-hot-sun');
        const overlay = document.getElementById('overlay-canvas');
        const status = document.getElementById('status-text');

        let mood = 'happy';
        let manual = false;
        let manualTimer;
        const moodCycle = ['happy', 'sleep', 'rain', 'sun', 'hot'];

        function setMood(newMood) {
            mood = newMood;
            
            // Reset base
            cloud.style.display = 'none';
            sunNormal.style.display = 'none';
            sunHot.style.display = 'none';
            blushL.setAttribute('opacity', '0');
            blushR.setAttribute('opacity', '0');
            browL.setAttribute('opacity', '0');
            browR.setAttribute('opacity', '0');
            
            eyeL.setAttribute('ry', '35'); eyeR.setAttribute('ry', '35');
            eyeL.setAttribute('cy', '115'); eyeR.setAttribute('cy', '115');
            pupilL.setAttribute('rx', '14'); pupilL.setAttribute('ry', '18');
            pupilR.setAttribute('rx', '14'); pupilR.setAttribute('ry', '18');
            mouth.setAttribute('d', "M85,165 Q100,165 115,165");

            switch(mood) {
                case 'happy':
                    blushL.setAttribute('opacity', '1');
                    blushR.setAttribute('opacity', '1');
                    mouth.setAttribute('d', "M75,165 Q100,195 125,165");
                    break;
                case 'sleep':
                    eyeL.setAttribute('ry', '3'); eyeR.setAttribute('ry', '3');
                    eyeL.setAttribute('cy', '125'); eyeR.setAttribute('cy', '125');
                    pupilL.setAttribute('rx', '0'); pupilR.setAttribute('rx', '0');
                    mouth.setAttribute('d', "M95,165 Q100,165 105,165");
                    break;
                case 'rain':
                    cloud.style.display = 'block';
                    mouth.setAttribute('d', "M85,175 Q100,160 115,175");
                    break;
                case 'sun':
                    sunNormal.style.display = 'block';
                    blushL.setAttribute('opacity', '0.4');
                    blushR.setAttribute('opacity', '0.4');
                    break;
                case 'hot':
                    sunHot.style.display = 'block';
                    browL.setAttribute('opacity', '1');
                    browR.setAttribute('opacity', '1');
                    blushL.setAttribute('opacity', '0.8');
                    blushR.setAttribute('opacity', '0.8');
                    mouth.setAttribute('d', "M90,175 Q100,168 110,175"); 
                    break;
            }
        }

        // PartÃ­culas
        function spawnZzz() {
            if (mood !== 'sleep') return;
            const z = document.createElement('div');
            z.className = 'particle zzz';
            z.innerText = 'Z';
            z.style.left = (window.innerWidth / 2 + 50) + 'px';
            z.style.top = (window.innerHeight / 2 - 30) + 'px';
            overlay.appendChild(z);
            setTimeout(() => z.remove(), 3000);
        }

        function spawnHearts() {
            for(let i=0; i<6; i++) {
                setTimeout(() => {
                    const h = document.createElement('div');
                    h.className = 'particle heart';
                    h.innerHTML = 'â¤';
                    h.style.left = (Math.random() * 60 + 20) + '%';
                    h.style.top = '60%';
                    overlay.appendChild(h);
                    setTimeout(() => h.remove(), 2000);
                }, i * 200);
            }
        }

        function spawnRain() {
            if (mood !== 'rain') return;
            const drop = document.createElement('div');
            drop.className = 'particle rain-drop';
            drop.style.left = (window.innerWidth / 2 - 50 + Math.random() * 120) + 'px';
            drop.style.top = (window.innerHeight / 2 - 140) + 'px';
            overlay.appendChild(drop);
            setTimeout(() => drop.remove(), 700);
        }

        function spawnSweat() {
            if (mood !== 'hot') return;
            const s = document.createElement('div');
            s.className = 'particle sweat-drop';
            // Gota desde la frente (entre los ojos)
            s.style.left = (window.innerWidth / 2 + (Math.random() * 20 - 10)) + 'px';
            s.style.top = (window.innerHeight / 2 - 80) + 'px';
            overlay.appendChild(s);
            setTimeout(() => s.remove(), 2000);
        }

        // Fetch Weather
        async function fetchWeather() {
            if (manual) return;
            navigator.geolocation.getCurrentPosition(async (pos) => {
                const url = `https://api.openweathermap.org/data/2.5/weather?lat=${pos.coords.latitude}&lon=${pos.coords.longitude}&appid=${API_KEY}&units=metric&lang=es`;
                try {
                    const res = await fetch(url);
                    const data = await res.json();
                    const now = Date.now() / 1000;
                    const isNight = (now > data.sys.sunset || now < data.sys.sunrise);
                    const temp = data.main.temp;
                    const id = data.weather[0].id;

                    let newMood = 'happy';
                    if (isNight) newMood = 'sleep';
                    else if (temp >= 32) newMood = 'hot';
                    else if (id === 800) newMood = 'sun';
                    else if (id >= 200 && id < 600) newMood = 'rain';

                    setMood(newMood);
                    status.innerText = `${data.name}: ${Math.round(temp)}Â°C | ${data.weather[0].description}`;
                } catch (e) {
                    status.innerText = "Error API";
                }
            }, () => {
                status.innerText = "GPS Desactivado";
                setMood('happy');
            });
        }

        function cycleMoodManual() {
            manual = true;
            const currentIdx = moodCycle.indexOf(mood);
            const nextMood = moodCycle[(currentIdx + 1) % moodCycle.length];
            setMood(nextMood);
            if (nextMood === 'happy') spawnHearts();
            status.innerText = "DEMO: " + nextMood.toUpperCase();

            clearTimeout(manualTimer);
            manualTimer = setTimeout(() => { manual = false; fetchWeather(); }, 30000);
        }

        function handleTap() {
            if (mood === 'sleep') return;
            spawnHearts();
        }

        function blink() {
            if (mood !== 'sleep') {
                const oldRY = eyeL.getAttribute('ry');
                eyeL.setAttribute('ry', '2'); eyeR.setAttribute('ry', '2');
                setTimeout(() => {
                    eyeL.setAttribute('ry', '35'); eyeR.setAttribute('ry', '35');
                }, 150);
            }
            setTimeout(blink, Math.random() * 5000 + 2000);
        }

        function lookAround() {
            if (mood !== 'sleep') {
                const ox = (Math.random() - 0.5) * 14;
                const oy = (Math.random() - 0.5) * 8;
                pupilL.style.transform = `translate(${ox}px, ${oy}px)`;
                pupilR.style.transform = `translate(${ox}px, ${oy}px)`;
            }
            setTimeout(lookAround, 3000);
        }

        window.onload = () => {
            setMood('happy');
            fetchWeather();
            blink();
            lookAround();
            setInterval(spawnZzz, 1200);
            setInterval(spawnRain, 150);
            setInterval(spawnSweat, 2500);
            setInterval(fetchWeather, 15 * 60 * 1000);
        };
    </script>
</body>
</html>

